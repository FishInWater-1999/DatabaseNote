# HashMap 扩容机制是什么样的？



韭菜：我们知道数组容量是有限的

当插入的数据过多时就会扩容

衡量这一标准的是负载因子

负载因子大小为 0.75f 

也就是说一个容量为 16 的 HashMap

当插入第 13 个元素时就会扩容啦

张三：那他是怎么扩容的呢？

韭菜：Hashmap 的扩容

首先会创建一个新的数组

它的长度是原先的两倍

接着会遍历原数组

把所有 entry 都挪到新数组中去

张三：嗯？我不想搬家啊

张三：那为什么要重新 Hash 呢？

韭菜：我们知道 hash 值得计算方法是：

HashCode & （Length - 1）（HashCode 余上数组的长度减一）

所以当长度发生变化时

hash 值也会随之而变化

张三：那迁移时为什么使用尾插法呢？

韭菜：其实在 jdk 1.7 中

扩容是采用的是头插法

但头插法会改变节点的排列

因此在多线程场景下

原先按顺序排列的的链表

就有可能出现首尾相连的问题

旁白：呀！你脚脚踩我头上啦！

jdk 1.8 后就改用尾插法啦

这样一来原有顺序就不会受到影响

也就解决了节点相连成环的问题

张三：wow 原来是这样

韭菜：其实 HashMap 的扩容过程是很影响效率的

如果事先能确定有多少个元素需要存储

建议在初始化时就设置数组的容量

来防止反复扩容影响运行效率

我是黎明韭菜，一个会扩容的程序员（变胖）